<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Metadata Microservice</title>
    <link
      rel="shortcut icon"
      href="https://cdn.freecodecamp.org/universal/favicons/favicon-32x32.png"
      type="image/x-icon"
    />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" />
    <link href="/public/style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“ File Metadata Microservice</h1>
      <p class="intro">
        Drop a file below or click the area to upload.  
        This app will show you its <strong>name, type, and size</strong>.  
        You can also view or delete past uploads.
      </p>

      <!-- Upload Area -->
      <div id="upload-box" class="upload-box">
        <p id="upload-text">Drag & drop a file here, or click to select one</p>
        <form id="upload-form" enctype="multipart/form-data" method="POST" action="/api/fileanalyse">
          <input id="file-input" type="file" name="upfile" />
        </form>
      </div>

      <div class="tooltip-wrapper">
        <button id="upload-btn" class="disabled" disabled>
          <span class="btn-text">Upload File</span>
          <span class="loader hidden"></span>
        </button>
        <span id="upload-tooltip" class="tooltip">Please choose a file first.</span>
      </div>

      <!-- Uploaded File Metadata -->
      <div id="result" class="result hidden">
        <h2>âœ… Uploaded Successfully!</h2>
        <div class="metadata-card">
          <div id="preview-container" class="preview-container hidden">
            <img id="preview-image" alt="File preview" />
          </div>
          <div class="metadata-row">
            <span class="metadata-label">File Name:</span>
            <span class="metadata-value" id="meta-name"></span>
          </div>
          <div class="metadata-row">
            <span class="metadata-label">File Type:</span>
            <span class="metadata-value" id="meta-type"></span>
          </div>
          <div class="metadata-row">
            <span class="metadata-label">File Size:</span>
            <span class="metadata-value" id="meta-size"></span>
          </div>
        </div>
      </div>

      <!-- Upload History -->
      <div class="history">
        <h2>ğŸ“œ Upload History</h2>
        <div id="history-list"><p>Loading...</p></div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this file and its metadata?</p>
        <div class="modal-actions">
          <button id="confirm-delete" class="delete-btn">Delete</button>
          <button id="cancel-delete" class="cancel-btn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal">
      <div class="modal-content error-modal">
        <h3>âš ï¸ Upload Failed</h3>
        <p id="error-message"></p>
        <div class="modal-actions">
          <button id="error-ok" class="cancel-btn">OK</button>
        </div>
      </div>
    </div>

    <script>
      const uploadBox = document.getElementById('upload-box');
      const fileInput = document.getElementById('file-input');
      const form = document.getElementById('upload-form');
      const result = document.getElementById('result');
      const uploadBtn = document.getElementById('upload-btn');
      const uploadText = document.getElementById('upload-text');
      const historyList = document.getElementById('history-list');
      const uploadTooltip = document.getElementById('upload-tooltip');
      const modal = document.getElementById('modal');
      const confirmDelete = document.getElementById('confirm-delete');
      const cancelDelete = document.getElementById('cancel-delete');
      const errorModal = document.getElementById('error-modal');
      const errorMessage = document.getElementById('error-message');
      const errorOk = document.getElementById('error-ok');
      const btnText = document.querySelector('.btn-text');
      const loader = document.querySelector('.loader');

      let deleteTarget = null;
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      
      // Dangerous file extensions blocked for security
      const BLOCKED_EXTENSIONS = [
        'exe', 'bat', 'cmd', 'com', 'msi', 'scr', 'vbs', 'ps1',
        'sh', 'bash', 'app', 'dmg', 'apk', 'jar', 'deb', 'rpm',
        'php', 'asp', 'aspx', 'jsp', 'cgi', 'pl', 'py', 'rb',
        'html', 'htm', 'hta', 'lnk', 'pif', 'reg', 'dll', 'sys'
      ];

      // --- Drag & Drop Handlers ---
      uploadBox.addEventListener('click', () => fileInput.click());
      
      uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBox.classList.add('dragover');
        uploadText.innerHTML = 'ğŸ¯ Drop it here!';
      });
      
      uploadBox.addEventListener('dragleave', () => {
        uploadBox.classList.remove('dragover');
        uploadText.textContent = 'Drag & drop a file here, or click to select one';
      });
      
      uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        fileReady();
      });

      fileInput.addEventListener('change', fileReady);

      function fileReady() {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          
          // Get file extension
          const fileExt = file.name.split('.').pop().toLowerCase();
          
          // Check if file type is blocked
          if (BLOCKED_EXTENSIONS.includes(fileExt)) {
            showError(`File type not allowed: .${fileExt} files are blocked for security reasons. Please upload documents, images, or media files instead.`);
            resetUploadArea();
            return;
          }
          
          // Check file size before enabling upload
          if (file.size > MAX_FILE_SIZE) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            showError(`File is too large (${sizeMB} MB). Maximum file size is 10 MB.`);
            resetUploadArea();
            return;
          }
          
          uploadBox.classList.add('ready');
          uploadText.textContent = `âœ… ${file.name} ready to upload!`;
          uploadBtn.disabled = false;
          uploadBtn.classList.remove('disabled');
          uploadTooltip.style.visibility = 'hidden';
        }
      }

      // --- Upload Logic ---
      uploadBtn.addEventListener('click', async () => {
        if (!fileInput.files.length) return;
        
        // Show loading state
        uploadBtn.disabled = true;
        btnText.classList.add('hidden');
        loader.classList.remove('hidden');
        
        try {
          const formData = new FormData(form);
          const res = await fetch('/api/fileanalyse', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.error) {
            showError(data.error);
            resetUploadArea();
            return;
          }

          // Display metadata in a friendly format
          result.classList.remove('hidden');
          document.getElementById('meta-name').textContent = data.name;
          document.getElementById('meta-type').textContent = data.type;
          document.getElementById('meta-size').textContent = data.size;
          
          // Show image preview if it's an image
          const file = fileInput.files[0];
          if (data.type && data.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById('preview-image').src = e.target.result;
              document.getElementById('preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          } else {
            document.getElementById('preview-container').classList.add('hidden');
          }
          
          // Reset upload area
          resetUploadArea();
          
          // Refresh history
          await loadHistory();
        } catch (err) {
          showError('Upload error: ' + err.message);
          resetUploadArea();
        }
      });

      function resetUploadArea() {
        fileInput.value = '';
        uploadBox.classList.remove('ready');
        uploadText.textContent = 'Drag & drop a file here, or click to select one';
        uploadBtn.disabled = true;
        uploadBtn.classList.add('disabled');
        uploadTooltip.style.visibility = 'visible';
        btnText.classList.remove('hidden');
        loader.classList.add('hidden');
      }

      // --- Load History ---
      async function loadHistory() {
        try {
          const res = await fetch('/api/history');
          const files = await res.json();

          historyList.innerHTML = files.length
            ? files
                .map(
                  (f) => {
                    const sizeBytes = typeof f.size === 'string' ? parseInt(f.size) : f.size;
                    const sizeMB = (sizeBytes / (1024 * 1024)).toFixed(2);
                    const sizeDisplay = `${sizeBytes.toLocaleString()} bytes (${sizeMB} MB)`;
                    const isImage = f.type && f.type.startsWith('image/');
                    
                    return `
                <div class="history-item">
                  <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <div class="file-preview-thumb">
                      ${isImage ? `<img src="${f.path}" alt="${escapeHtml(f.name)}" class="thumb-image" />` : `<span class="file-icon">${getFileIcon(f.type)}</span>`}
                    </div>
                    <div>
                      <strong>${escapeHtml(f.name)}</strong> (${escapeHtml(f.type)}) â€” ${sizeDisplay}
                      <br><small style="color: #888;">Uploaded: ${formatDate(f.uploadedAt)}</small>
                    </div>
                  </div>
                  <div class="history-actions">
                    <button class="view-btn" title="View file metadata" data-name="${escapeHtml(f.name)}" data-type="${escapeHtml(f.type)}" data-size="${sizeDisplay}" data-path="${f.path || ''}">View</button>
                    <button class="delete-btn" title="Delete file" data-filename="${f.filename}">Delete</button>
                  </div>
                </div>`;
                  }
                )
                .join('')
            : '<p>No uploads yet.</p>';

          // Attach event listeners
          document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const metadata = {
                name: e.target.dataset.name,
                type: e.target.dataset.type,
                size: e.target.dataset.size,
                path: e.target.dataset.path
              };
              viewMetadata(metadata);
            });
          });

          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              openModal(e.target.dataset.filename);
            });
          });
        } catch (err) {
          historyList.innerHTML = '<p>Error loading history.</p>';
          console.error('Error loading history:', err);
        }
      }

      // --- View Metadata ---
      function viewMetadata(metadata) {
        result.classList.remove('hidden');
        document.getElementById('meta-name').textContent = metadata.name;
        document.getElementById('meta-type').textContent = metadata.type;
        document.getElementById('meta-size').textContent = metadata.size;
        
        // Show image preview if it's an image and we have the path
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        
        if (metadata.type && metadata.type.startsWith('image/') && metadata.path) {
          previewImage.src = metadata.path;
          previewContainer.classList.remove('hidden');
        } else {
          previewContainer.classList.add('hidden');
        }
        
        result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // --- Delete Modal ---
      function openModal(filename) {
        deleteTarget = filename;
        modal.classList.remove('hidden');
        modal.classList.add('show');
      }

      function closeModal() {
        modal.classList.remove('show');
        setTimeout(() => modal.classList.add('hidden'), 200);
      }

      cancelDelete.addEventListener('click', closeModal);

      confirmDelete.addEventListener('click', async () => {
        if (deleteTarget) {
          try {
            const res = await fetch('/api/delete/' + deleteTarget, { method: 'DELETE' });
            const data = await res.json();
            
            if (data.error) {
              showError('Delete failed: ' + data.error);
            } else {
              // Hide the result section after deletion
              result.classList.add('hidden');
            }
            
            deleteTarget = null;
            closeModal();
            await loadHistory();
          } catch (err) {
            showError('Delete error: ' + err.message);
          }
        }
      });

      // Close modal on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // --- Error Modal Functions ---
      function showError(message) {
        errorMessage.textContent = message;
        errorModal.classList.remove('hidden');
        errorModal.classList.add('show');
      }

      function closeErrorModal() {
        errorModal.classList.remove('show');
        setTimeout(() => errorModal.classList.add('hidden'), 200);
      }

      errorOk.addEventListener('click', closeErrorModal);
      
      errorModal.addEventListener('click', (e) => {
        if (e.target === errorModal) closeErrorModal();
      });

      // --- Utility Functions ---
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      function getFileIcon(mimeType) {
        if (!mimeType) return 'ğŸ“„';
        
        if (mimeType.startsWith('image/')) return 'ğŸ–¼ï¸';
        if (mimeType.startsWith('video/')) return 'ğŸ¬';
        if (mimeType.startsWith('audio/')) return 'ğŸµ';
        if (mimeType.includes('pdf')) return 'ğŸ“•';
        if (mimeType.includes('zip') || mimeType.includes('compressed')) return 'ğŸ—œï¸';
        if (mimeType.includes('word') || mimeType.includes('document')) return 'ğŸ“';
        if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'ğŸ“Š';
        if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'ğŸ“ˆ';
        if (mimeType.includes('text')) return 'ğŸ“„';
        if (mimeType.includes('json') || mimeType.includes('javascript') || mimeType.includes('xml')) return 'ğŸ“‹';
        
        return 'ğŸ“„';
      }

      // --- Initialize ---
      loadHistory();
    </script>
  </body>
</html>